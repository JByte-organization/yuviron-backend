name: Deploy PROD to Elastic Beanstalk

on:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    environment: prod
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore Yuviron.Api/Yuviron.Api.csproj

      - name: Publish
        run: dotnet publish Yuviron.Api/Yuviron.Api.csproj -c Release -o publish

      - name: Zip artifact
        run: cd publish && zip -r ../app.zip .

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy to Elastic Beanstalk (AWS CLI)
        run: |
          APP="${{ secrets.EB_APPLICATION_NAME }}"
          ENV="${{ secrets.EB_ENVIRONMENT_NAME }}"
          REGION="${{ secrets.AWS_REGION }}"
          VERSION="prod-${GITHUB_SHA}"

          S3_BUCKET="$(aws elasticbeanstalk create-storage-location --region "$REGION" --query 'S3Bucket' --output text)"

          aws s3 cp app.zip "s3://$S3_BUCKET/$APP/$VERSION.zip" --region "$REGION"

          aws elasticbeanstalk create-application-version \
            --application-name "$APP" \
            --version-label "$VERSION" \
            --source-bundle S3Bucket="$S3_BUCKET",S3Key="$APP/$VERSION.zip" \
            --region "$REGION"

          aws elasticbeanstalk update-environment \
            --environment-name "$ENV" \
            --version-label "$VERSION" \
            --region "$REGION"
